= 하드웨어 구성
:toc:
:toc-title:

== 시스템 사양

HyperCloud를 구성할 때 필요한 총 사양 정보는 다음과 같다.
[width="100%",options="header", cols="1,1,1,1"]
|====================
|구분|운영체제|CPU|메모리
|최소|Red Hat 8 계열|22 core|53 GiB
|권장|Red Hat 8 계열|52 core|95 GiB
|==================== 
+
NOTE: iptables 1.8.5 버전 이상을 권장한다.


Ai-DevOps를 통해 모델링 시 모델 별 추가적인 사양이 필요하다. Ai-DevOps에 포함된 기본 템플릿 모델 수행 사양 정보는 다음과 같다.
[width="100%",options="header", cols="1,1,1,1,1"]
|====================
|구분|운영체제|CPU|메모리|기타
|예제|Red Hat 8 계열|32 core|34 GiB|GPU
|====================

== 운영체제 설정
인스톨러를 통한 HyperCloud 설치 과정에서 네트워크 포워딩, 호스트 이름, 스왑 메모리, SELinux 관련 설정이 가능하다.

=== 네트워크 포워딩
IP 포워딩 기능을 활성화하기 위해 `/etc/sysctl.d` 하위에 99-kubernetes-cri.conf와 같은 파일을 추가로 생성하여 아래와 같이 파라미터의 값을 설정한다.
[width="100%",options="header", cols="2,1,2"]
|====================
|파라미터|설정값|설명
|net.ipv4.ip_forward|1|IP 포워딩 활성화
|net.bridge.bridge-nf-call-iptables|1|CNI 동작을 위한 iptables forward 활성화
|net.bridge.bridge-nf-call-ip6tables|1|CNI 동작을 위한 ip6tables forward 활성화
|====================

=== 호스트 이름
장비의 식별을 위해 호스트 이름을 설정한다.

. *호스트 이름 설정* +
RFC 1123에 정의된 규칙에 맞게 호스트 이름을 설정한다.
+
----
$ sudo hostnamectl set-hostname k8s-master
----
+
[NOTE]

====
RFC 1123에 정의된 규칙은 다음과 같다.

* 최대 63자를 포함할 수 있다. +
* 영어 소문자, 숫자, 특수문자(`-`)만 가능하다.
* 알파벳 문자로 시작해야 한다. (TD: RFC 1123의 경우 영어 소문자 또는 숫자로 시작해야 하는 것으로 파악됨. 확인 필요) +
* 영어 소문자, 숫자로 끝나야 한다.
====

. *호스트 이름 및 IP 주소 등록* +
`/etc/hosts` 파일을 열어 설정한 호스트 이름과 호스트의 IP 주소를 등록한다.
+
.예시
----
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

172.22.5.2 k8s-master
----

=== 스왑 메모리
kubelet에서 스왑 메모리를 지원하지 않으므로 `swapoff` 명령을 사용하여 스왑 메모리를 비활성화한다.
----
$ sudo swapoff -a
----
만약 스왑 메모리를 영구적으로 비활성화하려면 `/etc/fstab` 파일을 열어 아래의 행을 주석 처리한다.
----
# /dev/mapper/centos-swap swap                    swap    defaults        0
----

=== SELinux
리눅스에서 제공하는 보안 정책으로 인한 권한 문제가 발생할 수 있으므로 `setenforce` 명령을 사용하여 SELinux를 비활성화한다. 
----
$ sudo setenforce 0
----
만약 SELinux를 영구적으로 비활성화하려면 아래의 명령을 실행한다.
----
$ sudo sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config
----

== 네트워크 구성

=== 포트
HyperCloud에서 사용되는 주요 포트 목록은 다음과 같다.
[width="100%",options="header", cols="1,1,2"]
|====================
|프로토콜|포트 번호|용도
|ICMP|-|Ping 테스트
|TCP|22|SSH, SCP, SFTP
|TCP|80|HTTP
|TCP|179,5473|Calico BIRD
|TCP|443|HTTPS
|TCP|2379-2380|ETCD
|TCP|5000|Podman Registry
|TCP|6443|Kube API 서버
|TCP|7472|MetalLB speaker
|TCP|9000-9999|Calico, Node Exporter를 포함한 호스트 레벨 서비스
|TCP|10010|CRI-O
|TCP|10248|Kubelet
|TCP|10250-10259|Kubernetes가 기본적으로 사용하는 포트 (kubelet, kube-schduler, kube-controller-manager, kube-proxy) 
|TCP,UDP|53,9153|coredns
|UDP|53|DNS
|UDP|123|NTP
|UDP|4789|VXLAN
|UDP|6081|VXLAN
|UDP|9000-9999|Calico, Node Exporter를 포함한 호스트 레벨 서비스
|TCP/UDP|30000-32767|Kubernetes 노트 포트 범위
|====================

=== 도메인
HyperCloud에서 사용되는 주요 도메인 목록은 다음과 같다.
[width="100%",options="header", cols="1,1,1,2"]
|====================
|네임스페이스|호스트|기타|설명
|api-gateway-system|console.xx.xx|console.tmaxcloud.com|HyperCloud 메인 콘솔
|argocd|argocd.xx.xx|argocd.tmaxcloud.com|HyperCloud 모듈 관리 및 배포를 지원하는 애플리케이션
|cicd-system|cicd-webhook.xx.xx|cicd-webhook.tmaxcloud.com|Gitea의 이벤트를 받는 웹훅 서비스로, Gitea으로부터 이벤트를 받아 CI/CD 파이프라인을 동작
|gitea-system|gitea.xx.xx|gitea.tmaxcloud.com| 소스 코드 관리를 지원하는 애플리케이션
|helm-ns|helm.xx.xx|helm.tmaxcloud.com| 헬름 차트를 관리하는 애플리케이션
|hyperauth|hyperauth.xx.xx|hyperauth.tmaxcloud.com| HyperCloud 계정 인증/인가 관리
|hyperregistry|hyperregistry.xx.xx|hyperregistry.tmaxcloud.com| HyperCloud 컨테이너 이미지 레지스트리
|hyperregistry|hyperregistry-notary.xx.xx|hyperregistry-notary.tmaxcloud.com| 컨테이너 이미지 서명 관리 애플리케이션
|istio-system|kiali.xx.xx|kiali.cloudqa.com| Istio 서비스 메쉬를 위한 트래픽, 서비스, 라우팅 등의 모니터링 대시보드
|istio-system|jaeger.xx.xx|jaeger.cloudqa.com| 분산 시스템에서의 서비스 추적과 모니터링
|monitoring|grafana.xx.xx|grafana.tmaxcloud.com| Prometheus 메트릭 데이터 시각화
|====================

=== CoreDNS
HyperCloud에서 DNS 서버 역할을 하는 CoreDNS 설정을 통해 사용할 도메인을 등록할 수 있다. +
쿠버네티스 내부에서 DNS 처리가 필요한 경우 coredns config를 이용하여 설정한다.

.예시
----
apiVersion: v1
data:
  Corefile: |
    .:53 {
        log
        health {
           lameduck 5s
        }
        ready
        kubernetes cluster.local in-addr.arpa ip6.arpa {
           pods insecure
           fallthrough in-addr.arpa ip6.arpa
           ttl 30
        }
        prometheus :9153
        forward . /etc/resolv.conf {
           max_concurrent 1000
        }
        cache 30
        loop
        reload
        loadbalance
        template IN A {
            match "(^|[.])(hypercloud.com)[.]$"
            answer "{{ .Name }} 60 IN A 172.22.7.X"
            fallthrough
        }
    }
----

=== IP Pool
기본 IP Pool 외에 네임스페이스별 IP Pool을 분리할 수 있다.

. IP Pool 생성
+
.예시
----
apiVersion: crd.projectcalico.org/v1
kind: IPPool
metadata:
  name: another-ipv4-ippool <1>
spec:
  cidr: 10.128.128.0/24  <2>
  blockSize: 28  <3>
  ipipMode: Never   # AWS의 경우 Always  <4>
  vxlanMode: Never  # NCP의 경우 Always  <5>
natOutgoing: true  <6>
----
<1> IP Pool의 이름 (기본값: default-ipv4-ippool)
<2> Pod가 사용할 IP 대역
<3> 각 호스트 노드에서 관리할 만큼의 IP 대역 크기 (CIDR보다 큰 값으로 지정)
<4> IPIP 모드 설정 (image:../../images/figure_caution_icon.png[] IPIP 모드를 설정할 경우 Vxlan 모드는 설정할 수 없음)
* Always
* Never
* CrossSubnet
<5> Vxlan 모드 설정 (image:../../images/figure_caution_icon.png[] Vxlan 모드를 설정할 경우 IPIP 모드는 설정할 수 없음)
* Always
* Never
* CrossSubnet
<6> 컨테이너에서 외부로 전송되는 패킷의 NAT 처리 여부 (iptables의 Masquerade Rule에 의해서 외부에 연결됨)

. 네임스페이스 내의 모든 파드들이 IP Pool을 사용하도록 적용
+
.예시
----
apiVersion: v1
kind: Namespace
metadata:
  annotations: 
    cni.projectcalico.org/ipv4pools: '["another-ipv4-ippool"]' <1>
----
<1> 네임스페이스에 적용할 IP Pool의 이름
